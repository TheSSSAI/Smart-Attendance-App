# 1 Overview

## 1.1 Diagram Id

SEQ-ER-019

## 1.2 Name

User is Notified of Persistent Offline Sync Failure

## 1.3 Description

After an offline attendance record fails to sync for 24 hours, the user is presented with a persistent, non-dismissible notification in the app, prompting them to take manual action.

## 1.4 Type

üîπ ErrorHandling

## 1.5 Purpose

To prevent silent data loss for offline entries and to actively involve the user in resolving a persistent connectivity or data issue.

## 1.6 Complexity

Medium

## 1.7 Priority

üî¥ High

## 1.8 Frequency

OnDemand

## 1.9 Participants

- REPO-APP-MOBILE-010
- application-services-layer

## 1.10 Key Interactions

- A background process on the client or server identifies a locally cached record that has failed to sync for over 24 hours.
- The system logs the sync failure event to a server-side log for administrative monitoring.
- A state is updated locally on the user's device to indicate a sync failure.
- The mobile application UI detects this state and displays a persistent, non-dismissible banner or notification.
- The notification provides guidance and a button to manually trigger a sync attempt.

## 1.11 Triggers

- An offline record's age exceeds the 24-hour sync timeout.

## 1.12 Outcomes

- The user is made aware of the unsynced data.
- The risk of permanent data loss is minimized.

## 1.13 Business Rules

- The notification must be persistent and non-dismissible until the sync is successful (REQ-3.2.3).

## 1.14 Error Scenarios

- Manual sync attempt also fails, requiring further user troubleshooting (e.g., checking network, restarting app).

## 1.15 Integration Points

*No items available*

# 2.0 Details

## 2.1 Diagram Id

SEQ-ER-019

## 2.2 Name

User Notified of Persistent Offline Sync Failure

## 2.3 Description

Details the process where the mobile client detects an offline attendance record that has failed to sync for over 24 hours, logs the failure to the backend, and updates the local UI to show a persistent, non-dismissible notification prompting the user for manual intervention, as per REQ-1-047.

## 2.4 Participants

### 2.4.1 Client Application

#### 2.4.1.1 Repository Id

REPO-APP-MOBILE-010

#### 2.4.1.2 Display Name

Mobile Application (Flutter)

#### 2.4.1.3 Type

üîπ Client Application

#### 2.4.1.4 Technology

Flutter, Dart, Riverpod, Firestore SDK

#### 2.4.1.5 Order

1

#### 2.4.1.6 Style

| Property | Value |
|----------|-------|
| Shape | actor |
| Color | #4285F4 |
| Stereotype | ¬´Client¬ª |

### 2.4.2.0 Serverless Backend

#### 2.4.2.1 Repository Id

application-services-layer

#### 2.4.2.2 Display Name

Application Services

#### 2.4.2.3 Type

üîπ Serverless Backend

#### 2.4.2.4 Technology

Firebase Cloud Functions (TypeScript)

#### 2.4.2.5 Order

2

#### 2.4.2.6 Style

| Property | Value |
|----------|-------|
| Shape | participant |
| Color | #DB4437 |
| Stereotype | ¬´Backend¬ª |

## 2.5.0.0 Interactions

### 2.5.1.0 Internal Process

#### 2.5.1.1 Source Id

REPO-APP-MOBILE-010

#### 2.5.1.2 Target Id

REPO-APP-MOBILE-010

#### 2.5.1.3 Message

1. [Trigger] BackgroundSyncCheckService runs on a timer or app startup.

#### 2.5.1.4 Sequence Number

1

#### 2.5.1.5 Type

üîπ Internal Process

#### 2.5.1.6 Is Synchronous

‚úÖ Yes

#### 2.5.1.7 Return Message



#### 2.5.1.8 Has Return

‚ùå No

#### 2.5.1.9 Is Activation

‚úÖ Yes

#### 2.5.1.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | Internal |
| Method | checkForStaleOfflineRecords() |
| Parameters | syncTimeout: 24 hours |
| Authentication | N/A |
| Error Handling | The service must handle exceptions gracefully to a... |
| Performance | The query against the local cache must be optimize... |

#### 2.5.1.11 Nested Interactions

*No items available*

### 2.5.2.0 Data Access

#### 2.5.2.1 Source Id

REPO-APP-MOBILE-010

#### 2.5.2.2 Target Id

REPO-APP-MOBILE-010

#### 2.5.2.3 Message

2. Query local Firestore cache for offline records with `creationTimestamp < now() - 24h`.

#### 2.5.2.4 Sequence Number

2

#### 2.5.2.5 Type

üîπ Data Access

#### 2.5.2.6 Is Synchronous

‚úÖ Yes

#### 2.5.2.7 Return Message

Returns list of stale record IDs.

#### 2.5.2.8 Has Return

‚úÖ Yes

#### 2.5.2.9 Is Activation

‚ùå No

#### 2.5.2.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | Internal |
| Method | localStore.findStaleOfflineRecords() |
| Parameters | staleThreshold: Timestamp |
| Authentication | N/A |
| Error Handling | N/A |
| Performance | The local query should be indexed for performance. |

#### 2.5.2.11 Nested Interactions

*No items available*

### 2.5.3.0 API Call

#### 2.5.3.1 Source Id

REPO-APP-MOBILE-010

#### 2.5.3.2 Target Id

application-services-layer

#### 2.5.3.3 Message

3. For each stale record, invoke logging endpoint.

#### 2.5.3.4 Sequence Number

3

#### 2.5.3.5 Type

üîπ API Call

#### 2.5.3.6 Is Synchronous

‚ùå No

#### 2.5.3.7 Return Message

200 OK - Log Accepted

#### 2.5.3.8 Has Return

‚úÖ Yes

#### 2.5.3.9 Is Activation

‚úÖ Yes

#### 2.5.3.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | HTTPS (Firebase Callable Function) |
| Method | logSyncFailure(data) |
| Parameters | { recordId: string, clientTimestamp: ISOString, de... |
| Authentication | Firebase Auth JWT required. Rules validate user ow... |
| Error Handling | Client implements a retry with exponential backoff... |
| Performance | p95 latency < 500ms. |

#### 2.5.3.11 Nested Interactions

*No items available*

### 2.5.4.0 Logging

#### 2.5.4.1 Source Id

application-services-layer

#### 2.5.4.2 Target Id

application-services-layer

#### 2.5.4.3 Message

4. Write structured error log to Google Cloud Logging.

#### 2.5.4.4 Sequence Number

4

#### 2.5.4.5 Type

üîπ Logging

#### 2.5.4.6 Is Synchronous

‚úÖ Yes

#### 2.5.4.7 Return Message



#### 2.5.4.8 Has Return

‚ùå No

#### 2.5.4.9 Is Activation

‚ùå No

#### 2.5.4.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | GCP SDK |
| Method | console.error(jsonPayload) |
| Parameters | { severity: 'ERROR', message: 'Persistent Sync Fai... |
| Authentication | Service Account with `roles/logging.logWriter` IAM... |
| Error Handling | N/A - Managed by GCP platform. |
| Performance | N/A |

#### 2.5.4.11 Nested Interactions

*No items available*

### 2.5.5.0 State Management

#### 2.5.5.1 Source Id

REPO-APP-MOBILE-010

#### 2.5.5.2 Target Id

REPO-APP-MOBILE-010

#### 2.5.5.3 Message

5. Update local state to mark record with 'persistent_failure'.

#### 2.5.5.4 Sequence Number

5

#### 2.5.5.5 Type

üîπ State Management

#### 2.5.5.6 Is Synchronous

‚úÖ Yes

#### 2.5.5.7 Return Message



#### 2.5.5.8 Has Return

‚ùå No

#### 2.5.5.9 Is Activation

‚ùå No

#### 2.5.5.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | Internal |
| Method | SyncStateProvider.setFailureState(recordId) |
| Parameters | recordId: string |
| Authentication | N/A |
| Error Handling | State update must be transactional to ensure UI co... |
| Performance | Immediate. |

#### 2.5.5.11 Nested Interactions

*No items available*

### 2.5.6.0 UI Update

#### 2.5.6.1 Source Id

REPO-APP-MOBILE-010

#### 2.5.6.2 Target Id

REPO-APP-MOBILE-010

#### 2.5.6.3 Message

6. UI layer, listening to state changes, renders persistent, non-dismissible notification.

#### 2.5.6.4 Sequence Number

6

#### 2.5.6.5 Type

üîπ UI Update

#### 2.5.6.6 Is Synchronous

‚úÖ Yes

#### 2.5.6.7 Return Message



#### 2.5.6.8 Has Return

‚ùå No

#### 2.5.6.9 Is Activation

‚ùå No

#### 2.5.6.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | Internal (Riverpod State Listener) |
| Method | build(context) |
| Parameters | WidgetRef ref |
| Authentication | N/A |
| Error Handling | UI should gracefully handle the presence of multip... |
| Performance | UI must remain responsive (60fps) during the re-re... |

#### 2.5.6.11 Nested Interactions

*No items available*

### 2.5.7.0 User Interaction

#### 2.5.7.1 Source Id

REPO-APP-MOBILE-010

#### 2.5.7.2 Target Id

REPO-APP-MOBILE-010

#### 2.5.7.3 Message

7. [User Action] User taps 'Retry Sync' button in the notification.

#### 2.5.7.4 Sequence Number

7

#### 2.5.7.5 Type

üîπ User Interaction

#### 2.5.7.6 Is Synchronous

‚úÖ Yes

#### 2.5.7.7 Return Message



#### 2.5.7.8 Has Return

‚ùå No

#### 2.5.7.9 Is Activation

‚ùå No

#### 2.5.7.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | Internal (UI Event) |
| Method | onRetryButtonPressed() |
| Parameters | recordId: string |
| Authentication | N/A |
| Error Handling | Button should have a loading state to prevent mult... |
| Performance | Immediate feedback to user. |

#### 2.5.7.11 Nested Interactions

*No items available*

### 2.5.8.0 Alternative Flow

#### 2.5.8.1 Source Id

REPO-APP-MOBILE-010

#### 2.5.8.2 Target Id

REPO-APP-MOBILE-010

#### 2.5.8.3 Message

8. [ALT] Attempt to sync record with Firestore again. On success, clear 'persistent_failure' state and remove notification.

#### 2.5.8.4 Sequence Number

8

#### 2.5.8.5 Type

üîπ Alternative Flow

#### 2.5.8.6 Is Synchronous

‚ùå No

#### 2.5.8.7 Return Message

If failed, display temporary error (Toast) but keep persistent notification.

#### 2.5.8.8 Has Return

‚úÖ Yes

#### 2.5.8.9 Is Activation

‚ùå No

#### 2.5.8.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | Internal |
| Method | SyncService.manualRetrySync(recordId) |
| Parameters | recordId: string |
| Authentication | N/A |
| Error Handling | Handles Firestore exceptions (e.g., offline, permi... |
| Performance | Shows loading indicator during the sync attempt. |

#### 2.5.8.11 Nested Interactions

*No items available*

## 2.6.0.0 Notes

### 2.6.1.0 Content

#### 2.6.1.1 Content

The client-side check for stale records (Step 1) is crucial. It must be resilient to app restarts and device reboots. A persistent job scheduler or a timestamp check on every app launch is required.

#### 2.6.1.2 Position

Top

#### 2.6.1.3 Participant Id

REPO-APP-MOBILE-010

#### 2.6.1.4 Sequence Number

1

### 2.6.2.0 Content

#### 2.6.2.1 Content

The UI notification is a key requirement (REQ-3.2.3). It MUST NOT be dismissible by swiping or other standard UI actions. It is only removed programmatically upon a successful sync of the failed record.

#### 2.6.2.2 Position

Bottom

#### 2.6.2.3 Participant Id

REPO-APP-MOBILE-010

#### 2.6.2.4 Sequence Number

6

## 2.7.0.0 Implementation Guidance

| Property | Value |
|----------|-------|
| Security Requirements | The server-side `logSyncFailure` endpoint must be ... |
| Performance Targets | The client-side check for stale records should com... |
| Error Handling Strategy | This sequence IS an error handling strategy. If th... |
| Testing Considerations | Requires a test environment where the device clock... |
| Monitoring Requirements | A log-based metric and alert should be created in ... |
| Deployment Considerations | This feature should be deployed behind a feature f... |

